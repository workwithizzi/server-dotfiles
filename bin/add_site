#!/bin/bash
# shellcheck disable=SC1090

# #####################################

if [[ ! "$USER" = "root" ]]; then
	echo "You need to login as 'root' user before you can add a new site."
	return
fi

CREATED_DATE=$(date +"%d-%m-%y")
CREATED_TIME=$(date +"%H:%M:%S")

include "$HOME/env"

# #####################################

# Get the user input:
echo "Domain Name (example.com)?"
read -r DOMAIN

# Replace '.' with '_' to use for file names
export CLEAN_DOMAIN="${DOMAIN//./_}"

echo "Which user is the owner of this site? [Default = $ENV_SITE_OWNER"
read -r OWNER
if [[ ! "$OWNER" ]]; then
	OWNER="$ENV_SITE_OWNER"
fi

echo "What do you want the site's public directory to be? [Default = $ENV_PUBLIC_DIR]"
read -r PUBLIC_DIR
if [[ ! "$PUBLIC_DIR" ]]; then
	PUBLIC_DIR="$ENV_PUBLIC_DIR"
fi

read -r "REPLY?❓  "" Do you want to connect your site to Github? [y|n]  "
# Don't use Git
if [[ $REPLY =~ ^[n]$ ]]; then
	GIT_INTEGRATION=false
	source "$BIN/add_html_placeholder"

# Use Git
else
	GIT_INTEGRATION=true
	echo "What's the HTTPS URL of your Github repo?"
	read -r REPO
	echo "What branch do you want to use? [Default = $ENV_BRANCH]"
	read -r BRANCH
	if [[ ! "$BRANCH" ]]; then
		BRANCH="$ENV_BRANCH"
	fi

	# Create the directory for NGINX
	sudo mkdir -p "/var/www/$DOMAIN"

	git clone "$REPO" "/var/www/$DOMAIN/live"

	# Create deploy script
	source "$BIN/add_deploy_script"
	# Create webhook file
	source "$BIN/create_hook"

fi

# Create a new server block for NGINX
source "$BIN/add_site_nginx"

# SSL Cert
# #####################################
read -r "REPLY?❓  "" Do you want to add an SSL certificate? [y|n]  "
if [[ $REPLY =~ ^[n]$ ]]; then
	SSL_CERT=false

else
	SSL_CERT=true
	source "$BIN/add_site_ssl"
fi

# Save all the info for reference later
sudo touch "$INFO_PATH/$CLEAN_DOMAIN"

{
	echo "DOMAIN=\"$DOMAIN\""
	echo "OWNER=\"$OWNER\""
	echo "CREATED_DATE=\"$CREATED_DATE\""
	echo "CREATED_TIME=\"$CREATED_TIME\""
	echo "PUBLIC_DIR=\"$PUBLIC_DIR\""
	echo "GIT_INTEGRATION=\"$GIT_INTEGRATION\""
	echo "REPO=\"$REPO\""
	echo "BRANCH=\"$BRANCH\""
	echo "SSL_CERT=\"$SSL_CERT\""
	echo "DEPLOY_SECRET=\"$DEPLOY_SECRET\""
	echo "WEBHOOK_URL=\"http://$ENV_WEBHOOK_URL:9000/hooks/$CLEAN_DOMAIN\""
} >>"$INFO_PATH/$CLEAN_DOMAIN"

# Assign owner and set permissions
assign_file "$OWNER" "$INFO_PATH/$CLEAN_DOMAIN"
assign_dir "$OWNER" "/var/www/$DOMAIN"

# # Reload NGINX
# _nginx reload

unset DOMAIN CLEAN_DOMAIN OWNER CREATED_DATE CREATED_TIME PUBLIC_DIR GIT_INTEGRATION REPO BRANCH SSL_CERT DEPLOY_SECRET IP_ADDRESS
