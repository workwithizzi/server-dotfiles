#!/bin/bash

# Get Info
if [[ ! "$DOMAIN" ]]; then
	echo "Domain Name? [example.com]"
	read -r DOMAIN

	# If $DOMAIN is defined, then these be too
	echo "Associated username? [Default = $ENV_SITE_OWNER"
	read -r OWNER
	if [[ ! "$OWNER" ]]; then
		OWNER="$ENV_SITE_OWNER"
	fi
fi

CLEAN_DOMAIN="${DOMAIN//./_}"

# TODO: Add a way to create a unique secret for the deploy
echo "What is the secret key that you want to use for webhook?"
read -r DEPLOY_SECRET

# #####################################

if [[ ! -d "$HOOKS_PATH" ]]; then
	sudo mkdir -p "$HOOKS_PATH"
fi

# If hook file doesn't exist, create it using the template
# and make the file available to webhook
if [[ ! -f "$HOOKS_PATH/$CLEAN_DOMAIN.json" ]]; then
	sudo touch "$HOOKS_PATH/$CLEAN_DOMAIN.json"

	{
		echo "["
		echo "  {"
		echo "    \"id\": \"$CLEAN_DOMAIN\","
		echo "    \"execute-command\": \"$_scripts/$CLEAN_DOMAIN.sh\","
		echo "    \"command-working-directory\": \"/var/www/$DOMAIN/live/\","
		echo "    \"response-message\": \"Executing script...\","
		echo "    \"trigger-rule\": {"
		echo "      \"match\": {"
		echo "        \"type\": \"payload-hash-sha1\","
		echo "        \"secret\": \"$DEPLOY_SECRET\","
		echo "        \"parameter\": {"
		echo "          \"source\": \"header\","
		echo "          \"name\": \"X-Hub-Signature\""
		echo "        }"
		echo "      }"
		echo "    }"
		echo "  }"
		echo "]"
	} >>"$HOOKS_PATH/$CLEAN_DOMAIN.json"

	assign_file "$OWNER" "$HOOKS_PATH/$CLEAN_DOMAIN.json"

	# Make the file available to the '_webhook start' command
	echo "$CLEAN_DOMAIN" >>"$HOME/hooks"
fi
